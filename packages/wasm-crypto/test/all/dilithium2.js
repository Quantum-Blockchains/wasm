// Copyright 2019-2022 @polkadot/wasm-crypto authors & contributors
// SPDX-License-Identifier: Apache-2.0

import crypto from 'crypto';
import { assert, hexToU8a, stringToU8a, u8aToHex } from '@polkadot/util';

/**
 * @internal
 * @param {*} pair
 */
function extractKeys (pair) {
  return [pair, pair.slice(0, 32), pair.slice(32)];
}

/**
 * @internal
 * @param {*} wasm
 */
function randomPair (wasm) {
  return extractKeys(wasm.dilithium2KeypairFromSeed(crypto.randomBytes(32)));
}

/**
 * @param {*} wasm
 */
export function dilithium2PairFromSeed (wasm) {
  it('creates a known pair from a known seed', () => {
    const seed = [
      0x7C, 0x99, 0x35, 0xA0, 0xB0, 0x76, 0x94, 0xAA, 0x0C, 0x6D, 0x10, 0xE4, 0xDB, 0x6B,
      0x1A, 0xDD, 0x2F, 0xD8, 0x1A, 0x25, 0xCC, 0xB1, 0x48, 0x03, 0x2D, 0xCD, 0x73, 0x99,
      0x36, 0x73, 0x7F, 0x2D
    ];
    const [pair, sk, pk] = extractKeys(wasm.dilithium2KeypairFromSeed(seed));

//    console.log('\tSEC', u8aToHex(sk));
//    console.log('\tPUB', u8aToHex(pk));

    assert(u8aToHex(pair) === '0x7c9935a0b07694aa0c6d10e4db6b1add2fd81a25ccb148032dcd739936737f2d1c0ee1111b08003f28e65e8b3bdeb037cf8f221dfcdaf5950edb38d506d85bef6177e3de0d4f1ef5847735947b56d08e841db2444fa2b729adeb1417ca7adf42a1490c5a097f002760c1fc419be8325aad0197c52ced80d3df18e7774265b289912ceca1be3a90d8a4fde65c84c610864e47deecae3eea4430b9909559408d11a6abdb7db9336df7f96eab4864a6579791265fa56c348cb7d2ddc90e133a95c3f6b13601429f5408bd999aa479c1018159550ec55a113c493be648f4e036dd4f8c809e036b4fbb918c2c484ad8e1747ae05585ab433fdf461af03c25a773700721aa05f7379fe7f5ed96175d4021076e7f52b60308eff5d42ba6e093b3d0815eb3496646e49230a9b35c8d41900c2bb8d3b446a23127f7e096d85a1c794ad4c89277904fc6bfec57b1cdd80df9955030fdca741afbdac827b13ccd5403588af4644003c2265dfa4d419dbccd2064892386518be9d51c16498275ebecf5cdc7a820f2c29314ac4a6f08b2252ad3cfb199aa42fe0b4fb571975c1020d949e194ee1ead937bfb550bb3ba8e357a029c29f077554602e1ca2f2289cb9169941c3aafdb8e58c7f2ac77291fb4147c65f6b031d3eba42f2acfd9448a5bc22b476e07ccceda2306c554ec9b7ab655f1d7318c2b7e67d5f69bedf56000fda98986b5ab1b3a22d8dfd6681697b23a55c96e8710f3f98c044fb15f606313ee56c0f1f5ca0f512e08484fcb358e6e528ffa89f8a866ccff3c0c5813147ec59af0470c4aad0141d34f101da2e5e1bd52d0d4c9b13b3e3d87d1586105796754e7978ca1c68a7d85df112b7ab921b359a9f03cbd27a7eac87a9a80b0b26b4c9657ed85ad7fa2616ab345eb8226f69fc0f48183ff574bcd767b5676413adb12ea2150a0e97683ee54243c25b7ea8a718606f86993d8d0dace834ed341eeb724fe3d5ff0bc8b8a7b8104ba269d34133a4cf8300a2d688496b59b6fcbc61ae96062ea1d8e5b410c5671f424417ed693329cd983001ffcd10023d598859fb7ad5fd263547117100690c6ce7438956e6cc57f1b5de53bb0dc72ce9b6deaa85789599a70f0051f1a0e25e86d888b00df36bdbc93ef7217c45ace11c0790d70e9953e5b417ba2fd9a4caf82f1fce6f45f53e215b8355ef61d891df1c794231c162dd24164b534a9d48467cdc323624c2f95d4402ff9d66ab1191a8124144afa35d4e31dc86caa797c31f68b85854cd959c4fac5ec53b3b56d374b888a9e979a6576b6345ec8522c9606990281bf3ef7c5945d10fd21a2a1d2e5404c5cf21220641391b98bcf825398305b56e58b611fe5253203e3df0d22466a73b3f0fbe43b9a62928091898b8a0e5b269db586b0e4ddef50d682a12d2c1be824149aa254c6381bb412d77c3f9aa902b688c81715a59c839558556d35ed4fc83b4ab18181f40f73dcd76860d8d8bf94520237c2ac0e463ba09e3c9782380dc07fe4fcba340cc2003439fd2314610638070d6c9eea0a70bae83b5d5d3c5d3fde26dd01606c8c520158e7e5104020f248ceaa666457c10aebf068f8a3bd5ce7b52c6af0abd5944af1ad4752c9113976083c03b6c34e1d47ed69644cad782c2f7d05f8a148961d965fa2e1723a8ddebc22a90cd783dd1f4db38fb9ae5a6714b3d946781643d317b7dd79381cf789a9588bb3e193b92a0b60d6b07d047f6984b0609ec57543c394ca8d5e5bcc2a731a79618bd1e2e0da8704af98f20f5f8f5452ddf646b95b341dd7f0d2cc1fa15bd9895cd5b65aa1cb94b5e2e788fda9825b656639193d98328154a4f2c35495a38b6ea0d2ffaaa35df92c203c7f31cbbca7bd03c3c2302190cecd161fd49237e4f839e3f3', 'ERROR: pairFromSeed() does not match');                            
    assert(u8aToHex(sk) === '0x7c9935a0b07694aa0c6d10e4db6b1add2fd81a25ccb148032dcd739936737f2d', 'ERROR: Secret key');
    assert(u8aToHex(pk) === "0x1c0ee1111b08003f28e65e8b3bdeb037cf8f221dfcdaf5950edb38d506d85bef6177e3de0d4f1ef5847735947b56d08e841db2444fa2b729adeb1417ca7adf42a1490c5a097f002760c1fc419be8325aad0197c52ced80d3df18e7774265b289912ceca1be3a90d8a4fde65c84c610864e47deecae3eea4430b9909559408d11a6abdb7db9336df7f96eab4864a6579791265fa56c348cb7d2ddc90e133a95c3f6b13601429f5408bd999aa479c1018159550ec55a113c493be648f4e036dd4f8c809e036b4fbb918c2c484ad8e1747ae05585ab433fdf461af03c25a773700721aa05f7379fe7f5ed96175d4021076e7f52b60308eff5d42ba6e093b3d0815eb3496646e49230a9b35c8d41900c2bb8d3b446a23127f7e096d85a1c794ad4c89277904fc6bfec57b1cdd80df9955030fdca741afbdac827b13ccd5403588af4644003c2265dfa4d419dbccd2064892386518be9d51c16498275ebecf5cdc7a820f2c29314ac4a6f08b2252ad3cfb199aa42fe0b4fb571975c1020d949e194ee1ead937bfb550bb3ba8e357a029c29f077554602e1ca2f2289cb9169941c3aafdb8e58c7f2ac77291fb4147c65f6b031d3eba42f2acfd9448a5bc22b476e07ccceda2306c554ec9b7ab655f1d7318c2b7e67d5f69bedf56000fda98986b5ab1b3a22d8dfd6681697b23a55c96e8710f3f98c044fb15f606313ee56c0f1f5ca0f512e08484fcb358e6e528ffa89f8a866ccff3c0c5813147ec59af0470c4aad0141d34f101da2e5e1bd52d0d4c9b13b3e3d87d1586105796754e7978ca1c68a7d85df112b7ab921b359a9f03cbd27a7eac87a9a80b0b26b4c9657ed85ad7fa2616ab345eb8226f69fc0f48183ff574bcd767b5676413adb12ea2150a0e97683ee54243c25b7ea8a718606f86993d8d0dace834ed341eeb724fe3d5ff0bc8b8a7b8104ba269d34133a4cf8300a2d688496b59b6fcbc61ae96062ea1d8e5b410c5671f424417ed693329cd983001ffcd10023d598859fb7ad5fd263547117100690c6ce7438956e6cc57f1b5de53bb0dc72ce9b6deaa85789599a70f0051f1a0e25e86d888b00df36bdbc93ef7217c45ace11c0790d70e9953e5b417ba2fd9a4caf82f1fce6f45f53e215b8355ef61d891df1c794231c162dd24164b534a9d48467cdc323624c2f95d4402ff9d66ab1191a8124144afa35d4e31dc86caa797c31f68b85854cd959c4fac5ec53b3b56d374b888a9e979a6576b6345ec8522c9606990281bf3ef7c5945d10fd21a2a1d2e5404c5cf21220641391b98bcf825398305b56e58b611fe5253203e3df0d22466a73b3f0fbe43b9a62928091898b8a0e5b269db586b0e4ddef50d682a12d2c1be824149aa254c6381bb412d77c3f9aa902b688c81715a59c839558556d35ed4fc83b4ab18181f40f73dcd76860d8d8bf94520237c2ac0e463ba09e3c9782380dc07fe4fcba340cc2003439fd2314610638070d6c9eea0a70bae83b5d5d3c5d3fde26dd01606c8c520158e7e5104020f248ceaa666457c10aebf068f8a3bd5ce7b52c6af0abd5944af1ad4752c9113976083c03b6c34e1d47ed69644cad782c2f7d05f8a148961d965fa2e1723a8ddebc22a90cd783dd1f4db38fb9ae5a6714b3d946781643d317b7dd79381cf789a9588bb3e193b92a0b60d6b07d047f6984b0609ec57543c394ca8d5e5bcc2a731a79618bd1e2e0da8704af98f20f5f8f5452ddf646b95b341dd7f0d2cc1fa15bd9895cd5b65aa1cb94b5e2e788fda9825b656639193d98328154a4f2c35495a38b6ea0d2ffaaa35df92c203c7f31cbbca7bd03c3c2302190cecd161fd49237e4f839e3f3", 'ERROR: Public key');
  
  });
}

/**
 * @param {*} wasm
 */
export function dilithium2SignAndVerify (wasm) {
  it('signs and verifies', () => {
    const [, sk, pk] = randomPair(wasm);

    const signature = wasm.dilithium2Sign(pk, sk, stringToU8a('this is a message'));
    const isValid = wasm.dilithium2Verify(signature, stringToU8a('this is a message'), pk);

//    console.log('\tSIG', u8aToHex(signature));
//    console.log('\tPUB', u8aToHex(pk))
//    console.log('\tRES', isValid);

    assert(isValid, 'ERROR: Unable to verify signature');
  });
}

/**
 * @param {*} wasm
 */
export function dilithium2VerifyExisting (wasm) {
  it('verifies a known signature', () => {
    const isValid = wasm.dilithium2Verify(hexToU8a('0xf89fc402059d859bf2750ff61d5e7236f51a091221fc416dd908180816eb2935de7c36b08e759cfcfa88821137fe7fd6d1850779099d97bede307a6daac060260ea0d8087950c7c989734681d0316a768f48fd5b2c4f9fe6e80d056e70b0bcea185f576c1c1f476a168b19db34c8358fec172e32804318e620d4d92f75e9897356f3ae31435c71123fca6ce5145cf9f2ea2972a4b3c3613a5d88e8919b441673ce2a0a61f1749d38e0cb95792938b9882eaf4674c18aef745568a19baac58365f86bff4e3c7a80dd1db30dd8c4ceab5e24ebc312b09df55b485ba0c28682fa864ba1838b2d8929cccec5920fa7785aa38d003b358c70813410fd53b619ddd2e52a1098737221d9c4af60902180764912a01093fd10469f158093cab77c835ee03656c925940fcdb6a1b4454ca66f7fff6f96fbf634a767f60c85a1dfb37f4c0c4536a2fe6ecafe7911a8a9cd865cefcdfb0d68d8a8c5e4be02052e9863da6157546ecc842e16d0c517b0479df84899e27c559d184eff103a1bdaba41531a14f901679796c5015afdaf0075cdc967183e07395dc853e5d42e5c96980b4e539e710060d06b837536326adf1cd0f0adbd0337a494717af68e8e935b736b6808e5d728c0f250b08a1fe6f6e06bf7ef97cbc903a53b61eaa465819491f09e50c42f21388482b4fe43230c9dbb1c3f60adf2e65b1f79889aa2fcb7b9532eadfa661dc53e471d113a70ddd394d937b7f6b9fc6cd355a73db1b13ade8eb6a4f198fe70581120f73b0c8c833d80efe66c28e1b87e7adc66db53a32cd1b3174d052f7666fe0126a0072f40c1b36e5dc4f3f53fe99ffedac8218bf275bbdff376357df694fd1c6a11e52976460b25b7a5d7daa705645f9a404b9c5dbdef5a147016871663cbfa52cbe5eefe2265cabc5010d9502efda66ec006fe701052f2890bf63a67b8ad068961625f02b76eb33cfd3dc63ecd79571fce0c9aca64e05975c01137bbfe0edf98ce58b553be3a5ad5d56cc996507c49c0ec4032b1194a6ddb27456e3678f2bbd7fa6370f92a6366937299edb4e0edee6418ff3569907e254bae84420a22c1f4def9f64ee249fbcb87ff22b783a1bcb10bdfeeaa5aa540c3c468f8521f3bd452912d33dde8a0011293498f5f3606604d0bc25f95cf830bbc382e81de8476f28540793ae4a6d635f7683f05846e74dedfd3bc16858fb8cc91c12063fa3c7699b15ae6bc283a55b5d448b4a31c605523f5eee53fa8c16446813b4259dc3a15ef55d82bebdc801a8dfac43926178f8882625749f5be973b9e8857b96e600c0e6cd8b5a0177558dfc57b6f7e776e97ead5b1614467d8e6679cbf64d387a4386a84f4acfa0249417bedc824688cca9517dbf802ca1cebd2a822f89517c5750ca8ad7fdbcd3b46cce42834f13dbdffe3db3519d2d0c12fcf290e7bc2f05b1dc50736b604115717b283757d6694995b953aa6f9e46667427120b24bafa97ce62695bdf31aa4a9660dd9bb509895fbe940ca6c73bd9f56b23fa653a306a8890bd3a3720eb0c10ed76fc772ea15a42321b8c5ffaac71c9ff907a67a87cc4231c6edfcaba8975272bbad2caebde9c73780d26661ef37f0d480210c8af3a28d708cfdc0597a91d03d31da1095676f254dc5e2c37634e8009d969f9c9241044f44b9f92cd4443338686b28fa93b689f8a87b652c672162e98a9c4bc90f909cfcaa5af20e255e22fe74e8abc5058935fa87d59cd397cecd6765caf9911207d32720ab9ed910df0b6667462ddd69cc135d4d406c49294c3180be892586c3297ef7df9964509e0445b3244f95c407e4b5545f6bf72b6e3ad87aae03945405358cf56cc25700f25ca9ba16f33f1035eab98acb93d7fa0861e31d3630c2548568c771b9829c1e0992079f853d1608f38e17cd6a13e4eb934ef81a111325741ce758d0ff6d98239a1014da7e13e598a3df5d6db48d0653518668e6765c560872a501b77b1adb1e6e9c522a8f04037d21e9d14d4b23c79d28397530411d8a39e086d52345bd1eaaea128339869418588d179d0e7a2d1ab51c8387125101f92d719523a0c40b66c6e2ff874af5dca3891236180077ee2513fdee58a5e814d9fabdba6da1193f9e5a4744856dd2aa4114ab5eb0d481dfd49a5f2e6bb7d49906ac9bcd440bd2f297eead8f05f3e5b628c9b28dd5b00d674fc5391c9ed5eea4ce51019702324f28321e38470f501cf27b234ea8c936b003639a057305af299b82c34ffe628efc782b5fe17137f17cf3afe7d21f679ca1f63128728deff9c79b8890ab4b6278fd600263a0fe59a752d073913c58bd34f52984637f0e128dda54fd7fdd4bb3d9f0cd20bb4184f12d6190c8a6fb05b5355fb924579d6ae8ee236c6ec0ef573736950c6bfedc447d423f618974b73ee280e6beb4b22a8d1cec6f4fd5dbbb4c77263b07684452ca0585bbf98d4ef2eb162dd480db48175899db43463244c12acb9abf4f77c104e4b3e008a492f95bf4ca0e53da6eea7be1f24a8d5287bc17412bda8142311e7070b70a2bf4c319e04c3e18f5e758fec0719646415afe786137110b1c220b8826b362813ce52281185a45f9bb697c346c8b0d8c5c7b910250843dcea8bd3096f553394822bfbf7d07a1e0a00716bca67506df1c8f39a0c6394a30832147bebf4d6e0061ab640ac6eba49bba7ea5895562b0b6b0921fae4366f5a3d96e7b74d07747cbbfd0a0b0e94f61c1bf1b923956dc4764621accaa94011e70a8a132ebf9eee5332138fe837416b9d1597c644bde667e4793f5907d1e5f8ef9879f7cc015f3e6622ad4e20c0d1dfa68c6bafd1102ebf42be2e2587374006fe3bcdffe2eb0fea8aef49558d6f6f74b43d10484baa101b63dd571bd6fac7d358bc2ae166eaf93d976d175d259e7ecedbd0dc095a7bd6631b3b3bff31a47da31dadbb317a674b81bc0de8382ab3c23ddbbfae2aba6531a108a914ae32a65ab6fa4db585bac8cf19d6e6aed6a3cb7c7475caf667387667c27a8c2f0eef32d68b8314b55a38b1f77294c22fdd5344ed8fb250fe702aa8aaee22493064ecb430e0db4a35c50d97877f0f6c068ab1ae87ce532cdc5f387070fc461e19fe150bba973715343a2b1b717b6d851893352b7eb8215ca32307b1141aceb54a3123ed21ba4248fabde4a75da797cebd747af250bc716b17055d42d39d2363434156667da268abe0ce92e27adbb0b9d54cf4047ca928b6974e8ee0f6f5184b730ca4400a64764c6356641b75f6389f4037dc1bab03a840a57c151a5ec232f04b23c5200bb2ba3a5b72437c4c91e43646e78889eaaafd6e3f2fc000f131a1c26282a2d36546377c4f90005347174799babbdcfddf1f405070b323547535a7386898c909bd3d4d9dbdddee6eef5000000000000000000000000000000000d1c2940'), stringToU8a('this is a message'), hexToU8a('0xde4128d2b422c80434a0d4a3ca48580d4d433ab24134c843834a8ed432610aac36affda4b96d6f063e1de27afe29be3c01369ce7dd02826d7c429d6437b0d811dcad224de4379760d01e5f59eec7a625e51defd309aa82fd2db9633e31d193110e0ef3f333612b9bf1f736fd4705507e337630cd885a8fd9521d95b32d9be7f6c47ef85ba6de6e6a7471f2d7d6e57749b14f74d2ab9ba465e57874e10d5396e3b0b957430ccc86f83a51d0e44df5ad7c22f0c9ad911bfd28ff9e0f83bc4ba3f0eed3a2d5428a4463de5dfcb3daf268a126bcd752dff13ead5afb88199a8fa8c5c56e338f4faa008d834f247964c7a48e694deab2535a18eb634c013d2771d968e70f97717a6510e3eb0866b048f37341e22bf85cd48828ca38519a13a5b09139b605ad56bb9139a54a5dc08679b200276fde586f99cdffd5c9410073c748ce92c1a0dc4a11099c8b76b6019e9bbcb18ea10f96b9dba0c34db4c4e955ec7088b423aecd9fe7a8db253a54e1a720512a98f5419a71546dcaa33023f0ec8297ce41acda16849582d40d7f181e224f422906a0a0194e76fe4efb450351a0cba610e2d977d80bbd686dfe87627793c92b1fba927eb9b73c5a1ded3a6384099ad3a720e3fd4721e30b29fbb26daeee283cbd7681ccfc4feae639b773e0ac88881a44ed08d6c8c19a85a9eab82ae4f65315c95aba59138cd9aeb41e449b110e28a005f743d9e3824de8d695bc436b2171c8f8e0fd9746ffb26c4d1f6189578bf0793cc3bb0e68bc29702db9114cf01abd237038e8d08eaa55328f2b7f8401dd225f6f3410224acffddb5a164c86a24e67733d2d46e797e5fd75836c31e400222c0c146a43f21feabc4efd78a7bb8cca01b7f84259aa9ba1fba8aa578195e72d0cfb0fa9873991b2d38875ece27b8c5c916adf9c522625c6fbaaa4da4cee405610d47be60d00b3e1cc78ef6c9c0022ef7af26d2fef6be4edc94210a6bdec89b2bd973a6de6b1c5898dcf3371ac15152cfd3f226d1f9fb7f64c22035f0b2cfe17b94aebf9964b31f7497e5c0552f16074489697ed43fd444a714db7505a7003fe6a57a2f8bafe3eb1a8da7e3649d02159317262d96e82288190cd1da1e043d3cd8fe5317eddebd69784749843e89c28c1a977c5afbb2c84f481e06a3a1a5b929b246b20e365d2eccce1cd7f1224141ceb6a28cfeddd458d9fac4deaf0b4799bbf199001f29f9e1b31da07f801d6c2a297ee1c47b647fe614a89bbddf50c278f76682bc05adbe8ea9d7e75fc864b8a0320c1ad944708ff5c8108e0bbf8a29034dca286fce0c7152da9fb07dbaf4a9cfb9ea50fb57c707e31cd5b54952a7ef79d4bdf86b728374ab642c2c526c52bff75abc34d0307d9d3889420efd9f322ee477bbb47f26faef4556c94b8b7e8836c2d298f59109735164a5edffb2796e8f3e9830b316241f3d2c5af93b41ea87a9189d9c6681cfcbed1fb83e47c31ed421ba9070c68b72a753b2344fd2e39f014a3cb99a1f077f992b3eb7945df3ebee0194a18e41381632a48d31af8fc5ce3f3ed45b149e610333ed59f5a012a0bf4e12be25b0a6e876e44f2b4d4721a7cd136dd72c8a7e679b8c31b084000001b012e26f78a8824c99aaf8ea094706207ea399c14a6fa7ea0de3b6b60cc0b8df8414f7ba3410f718475988649b7ea51a4f30221fdd9184d8acdf1c2af875add72cd9a8bfe84377dceb998225a9e738d0fd80187ecc57d8c95989a0bf28dbb177488fddb971fe473cd12e03687a8ce2687fa75fd502440b8306565bf4e572fc92e184caa34c81e79e2fa9fb8b02387d919871e84fc6bda115c81ef13290cc44f09eb6757d10f60abcbed'));

//    console.log('\tRES', isValid);

    assert(isValid, 'ERROR: Unable to verify signature');
  });
}

/**
 * @param {*} wasm
 */
export function dilithium2Benchmark (wasm) {
  it('runs a verification benchamark', () => {
    const MESSAGE = stringToU8a('this is a message');

    for (let i = 0; i < 256; i++) {
//      const seed = crypto.randomBytes(32);
//      const [, sk, pk] = extractKeys(wasm.dilithium2KeypairFromSeed(seed));
      const [, sk, pk] = randomPair(wasm);

      assert(wasm.dilithium2Verify(wasm.dilithium2Sign(pk, sk, MESSAGE), MESSAGE, pk), 'ERROR: Unable to verify signature');
    }
  });
}
